
* The economy is made of flows of materials
* Money replaces barter
* Why did people barter? Lack of trust
* People trust money instead of each other
* Money is alienating
* Money provides choice at the expense of relationships
* Money is not an essential part of the economy
* The economy is healthy/sustainable/viable iff the flows of materials meet people's needs
* What are the benefits of local, participatory, inter-organisational stock and flow modelling?

```{r}
library(tidyverse)

economy <- tibble::tribble(
  ~source,    ~quantity,  ~unit,    ~type,    ~destination,
  'Bakery A',        10,  'loaf',   'bread',  'Shop A',
  'Shop A',          10,  '£',      'money',  'Bakery A',
  'Bakery A',        10,  '£',      'money',  'Baker A',
  'Baker A',         10,  'hour',   'time',   'Bakery A',
  'Shop A',           1,  'loaf',   'bread',  'Baker A',
  'Baker A',          1,  '£',      'money',  'Shop A',
  'Mill A',        1000,  'gram',   'flour',  'Bakery A',
  'Bakery A',         5,  '£',      'money',  'Mill A',
  'Mill A',           5,  '£',      'money',  'Miller A',
  'Miller A',         5,  'hour',   'time',   'Mill A',
  'Miller A',         1,  '£',      'money',  'Shop A',
  'Shop A',           1,  'loaf',   'bread',  'Miller A',
)

DiagrammeR::grViz(
  paste0(
    "
      digraph {
          rankdir=LR;
    ",
    economy %>%
      filter(
        type != 'money'
      ) %>%
      mutate(
        graphviz_edge = glue::glue(
          "
            '{source}' -> '{destination}'
            [label='{quantity} {unit} {type}'];
          "
        )
      ) %>%
      `$`('graphviz_edge') %>%
      Reduce(glue::glue, .),
    "
    edge [color=blue];
    ",
    economy %>%
      filter(
        type == 'money'
      ) %>%
      mutate(
        graphviz_edge = glue::glue(
          "
            '{source}' -> '{destination}'
            [label='{quantity} {unit} {type}'];
          "
        )
      ) %>%
      `$`('graphviz_edge') %>%
      Reduce(glue::glue, .),
    "
      }
    "
  )
)

money_flows <- economy %>%
  filter(
    type == 'money'
  )

money_nodes <- c(money_flows$source, money_flows$destination) %>% unique()

money_flows <- money_flows %>%
  mutate(
    source_id = match(source, money_nodes),
    destination_id = match(destination, money_nodes)
  )

money_graph <- igraph::make_empty_graph() %>%
  igraph::add_vertices(
    length(money_nodes),
    name = money_nodes
  ) %>%
  igraph::add_edges(
    money_flows[, c('source_id', 'destination_id')] %>%
        as.matrix() %>%
        t() %>%
        as.vector(),
      quantity = money_flows$quantity
  )

plot(money_graph)

# Adapted from <https://stackoverflow.com/a/55094319>
FindCycles <- function(g) {
    Cycles = NULL
    for(v1 in igraph::V(g)) {
        if(igraph::degree(g, v1, mode="in") == 0) { next }
        GoodNeighbors = igraph::neighbors(g, v1, mode="out")
        GoodNeighbors = GoodNeighbors[GoodNeighbors > v1]
        for(v2 in GoodNeighbors) {
          TempCyc = lapply(igraph::all_simple_paths(g, v2,v1, mode="out"), function(p) c(v1,p))
          TempCyc = TempCyc[which(sapply(TempCyc, length) > 3)]
          TempCyc = TempCyc[sapply(TempCyc, min) == sapply(TempCyc, `[`, 1)]
          Cycles  = c(Cycles, TempCyc)
        }
    }
    Cycles
}

money_graph %>%
  FindCycles() %>%
  Map(
    function (x) {
      list(
        igraph::E(money_graph)[enexpr(x)],
        min(igraph::E(money_graph)[enexpr(x)]$quantity)
      )
    },
    .
  )
```
