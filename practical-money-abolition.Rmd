```{r}
library(tidyverse)

economy <- tibble::tribble(
  ~source,    ~quantity,  ~unit,    ~type,    ~destination,
  'Bakery A',        10,  'loaf',   'bread',  'Shop A',
  'Shop A',          10,  '£',      'money',  'Bakery A',
  'Bakery A',        10,  '£',      'money',  'Baker A',
  'Baker A',         10,  'hour',   'time',   'Bakery A',
  'Shop A',           1,  'loaf',   'bread',  'Baker A',
  'Baker A',          1,  '£',      'money',  'Shop A',
)

DiagrammeR::grViz(
  paste0(
    "
      digraph {
          node [shape=record];
          rankdir=LR;
    ",
    economy %>%
      pivot_longer(
        cols = c(source, destination),
        values_to = 'actor',
        names_to = 'direction'
      ) %>%
      group_by(actor) %>%
      summarise(
        types = type %>%
                  unique() %>%
                  sort() %>%
                  list()
      ) %>%
      rowwise() %>%
      mutate(
        graphviz_node = glue::glue(
          "
          '{actor}' [
            label=<<TABLE BORDER='0' CELLBORDER='1' CELLSPACING='0'>
                            <TR><TD><B>{actor}</B></TD></TR>
          ",
          Map(
            function (x) { glue:: glue("<TR><TD PORT='{x}'>{x}</TD></TR>") },
            types
          ) %>%
            unlist() %>%
            Reduce(glue::glue, .),
          "
                        </TABLE>>
            shape = 'none'
          ];
          "
        )
      ) %>%
      `$`('graphviz_node') %>%
      Reduce(glue::glue, .),
    economy %>%
      mutate(
        graphviz_edge = glue::glue("'{source}':'{type}':e -> '{destination}':'{type}':w")
      ) %>%
      `$`('graphviz_edge') %>%
      Reduce(glue::glue, .),
    "
      }
    "
  )
)

money_flows <- economy %>%
  filter(
    type == 'money'
  )

money_nodes <- c(money_flows$source, money_flows$destination) %>% unique()

money_flows <- money_flows %>%
  mutate(
    source_id = match(source, money_nodes),
    destination_id = match(destination, money_nodes)
  )

money_graph <- igraph::make_empty_graph() %>%
  igraph::add_vertices(
    length(money_nodes),
    name = money_nodes
  ) %>%
  igraph::add_edges(
    money_flows[, c('source_id', 'destination_id')] %>%
        as.matrix() %>%
        t() %>%
        as.vector(),
      quantity = money_flows$quantity
  )

plot(money_graph)

# Adapted from <https://stackoverflow.com/a/55094319>
FindCycles <- function(g) {
    Cycles = NULL
    for(v1 in igraph::V(g)) {
        if(igraph::degree(g, v1, mode="in") == 0) { next }
        GoodNeighbors = igraph::neighbors(g, v1, mode="out")
        GoodNeighbors = GoodNeighbors[GoodNeighbors > v1]
        for(v2 in GoodNeighbors) {
          TempCyc = lapply(igraph::all_simple_paths(g, v2,v1, mode="out"), function(p) c(v1,p))
          TempCyc = TempCyc[which(sapply(TempCyc, length) > 3)]
          TempCyc = TempCyc[sapply(TempCyc, min) == sapply(TempCyc, `[`, 1)]
          Cycles  = c(Cycles, TempCyc)
        }
    }
    Cycles
}

FindCycles(money_graph)[[1]]

igraph::E(money_graph)[[FindCycles(money_graph)[[1]]]]$quantity
```
