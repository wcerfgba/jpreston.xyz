```{r}
library(tidyverse)

economy <- tibble::tribble(
  ~source,    ~quantity,  ~unit,    ~type,    ~destination,
  'Bakery A',        10,  'loaf',   'bread',  'Shop A',
  'Shop A',          10,  '£',      'money',  'Bakery A',
  'Bakery A',        10,  '£',      'money',  'Baker A',
  'Baker A',         10,  'hour',   'time',   'Bakery A',
  'Shop A',           1,  'loaf',   'bread',  'Baker A',
  'Baker A',          1,  '£',      'money',  'Shop A',
)

DiagrammeR::grViz(
  paste0(
    "
      digraph {
          node [shape=record];
          rankdir=LR;
    ",
    economy %>%
      pivot_longer(
        cols = c(source, destination),
        values_to = 'actor',
        names_to = 'direction'
      ) %>%
      group_by(actor) %>%
      summarise(
        types = type %>%
                  unique() %>%
                  sort() %>%
                  list()
      ) %>%
      rowwise() %>%
      mutate(
        graphviz_node = glue::glue(
          "
          '{actor}' [
            label=<<TABLE BORDER='0' CELLBORDER='1' CELLSPACING='0'>
                            <TR><TD><B>{actor}</B></TD></TR>
          ",
          Map(
            function (x) { glue:: glue("<TR><TD PORT='{x}'>{x}</TD></TR>") },
            types
          ) %>%
            unlist() %>%
            Reduce(glue::glue, .),
          "
                        </TABLE>>
            shape = 'none'
          ];
          "
        )
      ) %>%
      `$`('graphviz_node') %>%
      Reduce(glue::glue, .),
    economy %>%
      mutate(
        graphviz_edge = glue::glue("'{source}':'{type}':e -> '{destination}':'{type}':w")
      ) %>%
      `$`('graphviz_edge') %>%
      Reduce(glue::glue, .),
    "
      }
    "
  )
)





# igraph stuff

flows <- economy %>%
  mutate(
    source = paste(source, '-', type),
    destination = paste(destination, '-', type)
  ) %>%
  select(
    !type
  )

nodes <- c(flows$source, flows$destination) %>% unique()

flows <- flows %>%
  mutate(
    source_id = match(source, nodes),
    destination_id = match(destination, nodes)
  )

igraph::make_empty_graph() %>%
  igraph::add_vertices(
    length(nodes),
    name = nodes
  ) %>%
  igraph::add_edges(
    flows[, c('source_id', 'destination_id')] %>%
        as.matrix() %>%
        t() %>%
        as.vector(),
      quantity = flows$quantity,
      unit = flows$unit
  ) %>%
  plot()
```
